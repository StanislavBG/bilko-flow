<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bilko Flow</title>
  <style>
    :root {
      --bg: #0f1117;
      --surface: #181a20;
      --surface-2: #1e2028;
      --border: #2a2d37;
      --border-hover: #3a3d47;
      --text: #e1e4ea;
      --text-secondary: #8b8fa3;
      --accent: #6c5ce7;
      --accent-hover: #7c6ef7;
      --green: #00b894;
      --red: #e17055;
      --yellow: #fdcb6e;
      --blue: #74b9ff;
      --cyan: #81ecec;
      --radius: 8px;
      --mono: 'SF Mono', 'Fira Code', 'Cascadia Code', Consolas, monospace;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Layout */
    .app { display: flex; min-height: 100vh; }

    .sidebar {
      width: 240px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-header h1 {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: -0.3px;
    }

    .sidebar-header span {
      font-size: 11px;
      color: var(--text-secondary);
      font-family: var(--mono);
    }

    .sidebar-nav { padding: 12px; flex: 1; }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: var(--radius);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 13px;
      transition: all 0.15s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .nav-item:hover { background: var(--surface-2); color: var(--text); }
    .nav-item.active { background: var(--accent); color: #fff; }
    .nav-item svg { width: 16px; height: 16px; flex-shrink: 0; }

    .sidebar-footer {
      padding: 16px;
      border-top: 1px solid var(--border);
    }

    .tenant-info {
      font-size: 11px;
      color: var(--text-secondary);
      font-family: var(--mono);
    }

    .tenant-info .label { color: var(--text-secondary); }
    .tenant-info .value { color: var(--text); display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .tenant-info > div { margin-bottom: 6px; }

    /* Main Content */
    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

    .topbar {
      height: 56px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      flex-shrink: 0;
    }

    .topbar h2 { font-size: 15px; font-weight: 600; }

    .topbar-actions { display: flex; gap: 8px; }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: var(--radius);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: var(--text);
    }

    .btn:hover { border-color: var(--border-hover); }

    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .btn-primary:hover { background: var(--accent-hover); border-color: var(--accent-hover); }

    .btn-sm { padding: 5px 10px; font-size: 12px; }

    .btn-danger { background: var(--red); border-color: var(--red); color: #fff; }
    .btn-danger:hover { opacity: 0.9; }

    .btn svg { width: 14px; height: 14px; }

    /* Cards */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
    }

    /* Stat cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
    }

    .stat-card .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-card .stat-value {
      font-size: 28px;
      font-weight: 700;
      font-family: var(--mono);
    }

    .stat-card .stat-sub {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* Tables */
    .table-wrap {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .table-header h3 { font-size: 14px; font-weight: 600; }

    table { width: 100%; border-collapse: collapse; }
    th {
      text-align: left;
      padding: 10px 20px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
      font-weight: 500;
    }

    td {
      padding: 12px 20px;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
    }

    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--surface-2); }

    .id-cell {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--blue);
      cursor: pointer;
    }

    .id-cell:hover { text-decoration: underline; }

    /* Status badges */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .badge-draft { background: rgba(139,143,163,0.15); color: var(--text-secondary); }
    .badge-draft .badge-dot { background: var(--text-secondary); }

    .badge-active { background: rgba(0,184,148,0.15); color: var(--green); }
    .badge-active .badge-dot { background: var(--green); }

    .badge-archived { background: rgba(225,112,85,0.15); color: var(--red); }
    .badge-archived .badge-dot { background: var(--red); }

    .badge-created { background: rgba(116,185,255,0.15); color: var(--blue); }
    .badge-created .badge-dot { background: var(--blue); }

    .badge-queued { background: rgba(253,203,110,0.15); color: var(--yellow); }
    .badge-queued .badge-dot { background: var(--yellow); }

    .badge-running { background: rgba(108,92,231,0.15); color: var(--accent); }
    .badge-running .badge-dot { background: var(--accent); animation: pulse 1.5s infinite; }

    .badge-succeeded { background: rgba(0,184,148,0.15); color: var(--green); }
    .badge-succeeded .badge-dot { background: var(--green); }

    .badge-failed { background: rgba(225,112,85,0.15); color: var(--red); }
    .badge-failed .badge-dot { background: var(--red); }

    .badge-canceled { background: rgba(139,143,163,0.15); color: var(--text-secondary); }
    .badge-canceled .badge-dot { background: var(--text-secondary); }

    .badge-pure { background: rgba(0,184,148,0.15); color: var(--green); }
    .badge-replayable { background: rgba(116,185,255,0.15); color: var(--blue); }
    .badge-best-effort { background: rgba(253,203,110,0.15); color: var(--yellow); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Forms / Modals */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      backdrop-filter: blur(4px);
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 90%;
      max-width: 640px;
      max-height: 85vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h3 { font-size: 15px; font-weight: 600; }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
    }

    .modal-body { padding: 24px; }
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .form-group { margin-bottom: 16px; }
    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg);
      color: var(--text);
      font-size: 13px;
      font-family: inherit;
    }

    .form-group textarea {
      font-family: var(--mono);
      font-size: 12px;
      resize: vertical;
      min-height: 120px;
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-hint {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* Flow Graph Canvas */
    .flow-canvas {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      min-height: 300px;
      position: relative;
      overflow: auto;
      padding: 32px;
    }

    .flow-graph {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      min-width: fit-content;
    }

    .flow-node {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 20px;
      min-width: 180px;
      text-align: center;
      position: relative;
      transition: border-color 0.15s;
    }

    .flow-node:hover { border-color: var(--accent); }

    .flow-node .node-type {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .flow-node .node-name {
      font-size: 13px;
      font-weight: 500;
    }

    .flow-node .node-id {
      font-size: 10px;
      font-family: var(--mono);
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .flow-node.entry { border-color: var(--green); }

    .flow-node.step-succeeded { border-color: var(--green); background: rgba(0,184,148,0.05); }
    .flow-node.step-failed { border-color: var(--red); background: rgba(225,112,85,0.05); }
    .flow-node.step-running { border-color: var(--accent); background: rgba(108,92,231,0.05); }
    .flow-node.step-pending { border-color: var(--border); }

    .flow-connector {
      width: 2px;
      height: 20px;
      background: var(--border);
      margin: 0 auto;
    }

    .flow-connector-arrow {
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-top: 6px solid var(--border);
      margin: 0 auto;
    }

    .flow-parallel {
      display: flex;
      gap: 24px;
      align-items: flex-start;
    }

    .flow-parallel-branch {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    /* Detail panel */
    .detail-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-top: 16px;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .detail-header h3 { font-size: 14px; font-weight: 600; }

    .detail-body { padding: 20px; }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .detail-field .field-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .detail-field .field-value {
      font-size: 13px;
    }

    .detail-field .field-value.mono {
      font-family: var(--mono);
      font-size: 12px;
    }

    /* JSON viewer */
    .json-view {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      font-family: var(--mono);
      font-size: 12px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 400px;
      overflow-y: auto;
      color: var(--text-secondary);
    }

    /* Step results */
    .step-results { margin-top: 16px; }
    .step-result-item {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 8px;
      overflow: hidden;
    }

    .step-result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      background: var(--surface-2);
    }

    .step-result-header:hover { background: var(--border); }

    .step-result-body {
      padding: 16px;
      border-top: 1px solid var(--border);
      display: none;
    }

    .step-result-body.open { display: block; }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-state svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.4; }
    .empty-state h3 { font-size: 15px; margin-bottom: 8px; color: var(--text); }
    .empty-state p { font-size: 13px; margin-bottom: 20px; }

    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 200;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 16px;
      font-size: 13px;
      min-width: 280px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      animation: slideIn 0.2s ease-out;
    }

    .toast-error { border-color: var(--red); }
    .toast-success { border-color: var(--green); }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Setup screen */
    .setup-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 24px;
    }

    .setup-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 40px;
      max-width: 480px;
      width: 100%;
    }

    .setup-card h2 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .setup-card p {
      color: var(--text-secondary);
      font-size: 13px;
      margin-bottom: 24px;
      line-height: 1.5;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }

    /* Loading spinner */
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
    }

    .tab {
      padding: 10px 16px;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
      transition: all 0.15s;
    }

    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    /* Sample flow template cards */
    .templates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .template-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .template-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }

    .template-card .template-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
      font-size: 18px;
    }

    .template-card h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .template-card p {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .template-meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .template-meta .badge { font-size: 10px; }

    .template-steps-preview {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .template-steps-preview .step-chip {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 2px 8px;
      font-size: 10px;
      font-family: var(--mono);
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .template-steps-preview .step-arrow {
      color: var(--border);
      font-size: 10px;
    }

    .section-heading {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .section-subheading {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }
  </style>
</head>
<body>

<div id="app"></div>
<div id="modal-root"></div>
<div class="toast-container" id="toast-container"></div>

<script>
// ---------------------------------------------------------------------------
// Bilko Flow â€” Dashboard UI
// ---------------------------------------------------------------------------

const API = window.location.origin;

// ---- State ----------------------------------------------------------------
const state = {
  view: 'dashboard',
  account: null,
  project: null,
  environments: [],
  identity: null,
  workflows: [],
  runs: [],
  selectedWorkflow: null,
  selectedRun: null,
  loading: false,
};

// ---- API helpers ----------------------------------------------------------
function apiHeaders() {
  const h = { 'Content-Type': 'application/json' };
  if (state.identity) h['x-identity-id'] = state.identity;
  if (state.account) h['x-account-id'] = state.account.id;
  if (state.project) h['x-project-id'] = state.project.id;
  if (state.environments.length) h['x-environment-id'] = state.environments[0].id;
  return h;
}

async function apiCall(method, path, body) {
  const opts = { method, headers: apiHeaders() };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(`${API}${path}`, opts);
  const data = await res.json();
  if (!res.ok) throw new Error(data?.error?.message || `API error ${res.status}`);
  return data;
}

// ---- Toast ----------------------------------------------------------------
function toast(msg, type = 'success') {
  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.textContent = msg;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

// ---- Persistence ----------------------------------------------------------
function saveSession() {
  const s = {
    account: state.account,
    project: state.project,
    environments: state.environments,
    identity: state.identity,
  };
  localStorage.setItem('bilko_session', JSON.stringify(s));
}

function loadSession() {
  try {
    const s = JSON.parse(localStorage.getItem('bilko_session'));
    if (s && s.account) {
      state.account = s.account;
      state.project = s.project;
      state.environments = s.environments || [];
      state.identity = s.identity;
      return true;
    }
  } catch {}
  return false;
}

// ---- Data loading ---------------------------------------------------------
async function loadWorkflows() {
  try {
    // The API doesn't have a list-all endpoint in the routes, so we track locally
    const saved = JSON.parse(localStorage.getItem('bilko_workflows') || '[]');
    const workflows = [];
    for (const id of saved) {
      try {
        const data = await apiCall('GET', `/api/workflows/${id}`);
        if (data.workflow) workflows.push(data.workflow);
      } catch {}
    }
    state.workflows = workflows;
  } catch {
    state.workflows = [];
  }
}

async function loadRuns() {
  try {
    const saved = JSON.parse(localStorage.getItem('bilko_runs') || '[]');
    const runs = [];
    for (const id of saved) {
      try {
        const data = await apiCall('GET', `/api/runs/${id}`);
        if (data.run) runs.push(data.run);
      } catch {}
    }
    state.runs = runs;
  } catch {
    state.runs = [];
  }
}

function trackWorkflow(id) {
  const saved = JSON.parse(localStorage.getItem('bilko_workflows') || '[]');
  if (!saved.includes(id)) { saved.push(id); localStorage.setItem('bilko_workflows', JSON.stringify(saved)); }
}

function trackRun(id) {
  const saved = JSON.parse(localStorage.getItem('bilko_runs') || '[]');
  if (!saved.includes(id)) { saved.push(id); localStorage.setItem('bilko_runs', JSON.stringify(saved)); }
}

// ---- SVG icons (minimal inline) -------------------------------------------
const icons = {
  dashboard: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>',
  workflow: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="2"/><circle cx="6" cy="19" r="2"/><circle cx="18" cy="19" r="2"/><path d="M12 7v4M12 11l-6 6M12 11l6 6"/></svg>',
  runs: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5,3 19,12 5,21"/></svg>',
  plus: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  refresh: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>',
  x: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
  empty: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9l6 6M15 9l-6 6"/></svg>',
  logout: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>',
  chevron: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>',
};

// ---- Sample flow templates ------------------------------------------------
const SAMPLE_FLOWS = [
  {
    id: 'content-curation',
    icon: '&#x1F4F0;',
    iconBg: 'rgba(116,185,255,0.15)',
    title: 'Content Curation Pipeline',
    description: 'Search the web for articles, filter by relevance, summarize the results, and send a notification with the digest.',
    grade: 'best-effort',
    stepTypes: ['http.search', 'transform.filter', 'ai.summarize', 'notification.send'],
    payload: {
      name: 'Content Curation Pipeline',
      description: 'Searches for articles on a topic, filters by relevance score, summarizes the top results using AI, and sends a digest notification.',
      determinism: { targetGrade: 'best-effort' },
      entryStepId: 'search',
      steps: [
        {
          id: 'search',
          name: 'Search Articles',
          type: 'http.search',
          dependsOn: [],
          inputs: { query: 'workflow orchestration', maxResults: 20, sortBy: 'relevance' },
          policy: { timeoutMs: 30000, maxAttempts: 3, backoffStrategy: 'exponential', backoffBaseMs: 1000 },
          determinism: { usesExternalApis: true, pureFunction: false }
        },
        {
          id: 'filter',
          name: 'Filter by Relevance',
          type: 'transform.filter',
          dependsOn: ['search'],
          inputs: { condition: 'item.score >= 0.7', field: 'relevanceScore' },
          policy: { timeoutMs: 5000, maxAttempts: 1 },
          determinism: { pureFunction: true }
        },
        {
          id: 'summarize',
          name: 'AI Summarize',
          type: 'ai.summarize',
          dependsOn: ['filter'],
          inputs: { model: 'claude-sonnet-4-5-20250929', maxTokens: 1024, prompt: 'Summarize these articles into a brief digest' },
          policy: { timeoutMs: 60000, maxAttempts: 2, backoffStrategy: 'exponential', backoffBaseMs: 2000 },
          determinism: { usesExternalApis: true, pureFunction: false }
        },
        {
          id: 'notify',
          name: 'Send Digest',
          type: 'notification.send',
          dependsOn: ['summarize'],
          inputs: { channel: 'email', recipient: 'team@example.com', subject: 'Daily Content Digest' },
          policy: { timeoutMs: 15000, maxAttempts: 3, backoffStrategy: 'exponential', backoffBaseMs: 1000 },
          determinism: { usesExternalApis: true, pureFunction: false }
        }
      ]
    }
  },
  {
    id: 'data-transform',
    icon: '&#x2699;&#xFE0F;',
    iconBg: 'rgba(0,184,148,0.15)',
    title: 'Data Transform Pipeline',
    description: 'A pure deterministic pipeline that maps, filters, and reduces a dataset. Fully replayable with identical outputs.',
    grade: 'pure',
    stepTypes: ['transform.map', 'transform.filter', 'transform.reduce'],
    payload: {
      name: 'Data Transform Pipeline',
      description: 'A pure deterministic pipeline: maps raw records to a normalized schema, filters out invalid entries, then reduces to aggregate statistics.',
      determinism: { targetGrade: 'pure' },
      entryStepId: 'normalize',
      steps: [
        {
          id: 'normalize',
          name: 'Normalize Records',
          type: 'transform.map',
          dependsOn: [],
          inputs: { expression: '{ id: item.id, value: parseFloat(item.amount), category: item.type.toLowerCase() }' },
          policy: { timeoutMs: 10000, maxAttempts: 1 },
          determinism: { pureFunction: true }
        },
        {
          id: 'validate',
          name: 'Filter Invalid',
          type: 'transform.filter',
          dependsOn: ['normalize'],
          inputs: { condition: 'item.value > 0 && item.category !== "unknown"' },
          policy: { timeoutMs: 5000, maxAttempts: 1 },
          determinism: { pureFunction: true }
        },
        {
          id: 'aggregate',
          name: 'Aggregate Stats',
          type: 'transform.reduce',
          dependsOn: ['validate'],
          inputs: { initialValue: { total: 0, count: 0 }, expression: '{ total: acc.total + item.value, count: acc.count + 1 }' },
          policy: { timeoutMs: 10000, maxAttempts: 1 },
          determinism: { pureFunction: true }
        }
      ]
    }
  },
  {
    id: 'ai-social',
    icon: '&#x1F916;',
    iconBg: 'rgba(108,92,231,0.15)',
    title: 'AI Social Media Post',
    description: 'Generate text content with AI, create an image, then publish to social media. Showcases parallel AI generation.',
    grade: 'best-effort',
    stepTypes: ['ai.generate-text', 'ai.generate-image', 'social.post'],
    payload: {
      name: 'AI Social Media Post',
      description: 'Uses AI to generate a caption and an image in parallel, then publishes both as a social media post.',
      determinism: { targetGrade: 'best-effort' },
      entryStepId: 'generate-text',
      steps: [
        {
          id: 'generate-text',
          name: 'Generate Caption',
          type: 'ai.generate-text',
          dependsOn: [],
          inputs: { model: 'claude-sonnet-4-5-20250929', prompt: 'Write a short, engaging social media caption about workflow automation', maxTokens: 256 },
          policy: { timeoutMs: 30000, maxAttempts: 2, backoffStrategy: 'exponential', backoffBaseMs: 1000 },
          determinism: { usesExternalApis: true, pureFunction: false }
        },
        {
          id: 'generate-image',
          name: 'Generate Image',
          type: 'ai.generate-image',
          dependsOn: [],
          inputs: { model: 'dall-e-3', prompt: 'Abstract geometric art representing automated workflows, purple and blue tones', size: '1024x1024' },
          policy: { timeoutMs: 60000, maxAttempts: 2, backoffStrategy: 'exponential', backoffBaseMs: 2000 },
          determinism: { usesExternalApis: true, pureFunction: false }
        },
        {
          id: 'publish',
          name: 'Publish Post',
          type: 'social.post',
          dependsOn: ['generate-text', 'generate-image'],
          inputs: { platform: 'twitter', includeImage: true },
          policy: { timeoutMs: 15000, maxAttempts: 3, backoffStrategy: 'exponential', backoffBaseMs: 1000 },
          determinism: { usesExternalApis: true, pureFunction: false }
        }
      ]
    }
  },
  {
    id: 'api-etl',
    icon: '&#x1F504;',
    iconBg: 'rgba(253,203,110,0.15)',
    title: 'API ETL with Retry',
    description: 'Extract data from an API, transform it, then load results via HTTP POST. Demonstrates retry policies and replayable determinism.',
    grade: 'replayable',
    stepTypes: ['http.request', 'transform.map', 'transform.reduce', 'http.request'],
    payload: {
      name: 'API ETL with Retry',
      description: 'Extracts order data from a REST API, transforms each record to extract key metrics, aggregates into a summary, and POSTs results to a reporting endpoint.',
      determinism: {
        targetGrade: 'replayable',
        externalDependencies: [
          { name: 'orders-api', kind: 'http-api', deterministic: false, evidenceCapture: 'full-response', nondeterminismDescription: 'Order data changes over time' },
          { name: 'reports-api', kind: 'http-api', deterministic: true, evidenceCapture: 'response-hash' }
        ]
      },
      entryStepId: 'extract',
      steps: [
        {
          id: 'extract',
          name: 'Extract Orders',
          type: 'http.request',
          dependsOn: [],
          inputs: { url: 'https://api.example.com/orders?status=completed&limit=100', method: 'GET', headers: { 'Accept': 'application/json' } },
          policy: { timeoutMs: 30000, maxAttempts: 3, backoffStrategy: 'exponential', backoffBaseMs: 2000 },
          determinism: {
            usesExternalApis: true,
            pureFunction: false,
            externalDependencies: [
              { name: 'orders-api', kind: 'http-api', deterministic: false, evidenceCapture: 'full-response', nondeterminismDescription: 'Order data changes over time' }
            ]
          }
        },
        {
          id: 'transform',
          name: 'Extract Metrics',
          type: 'transform.map',
          dependsOn: ['extract'],
          inputs: { expression: '{ orderId: item.id, revenue: item.total, region: item.shipping.country }' },
          policy: { timeoutMs: 10000, maxAttempts: 1 },
          determinism: { pureFunction: true }
        },
        {
          id: 'reduce',
          name: 'Summarize by Region',
          type: 'transform.reduce',
          dependsOn: ['transform'],
          inputs: { initialValue: {}, expression: '{ ...acc, [item.region]: (acc[item.region] || 0) + item.revenue }' },
          policy: { timeoutMs: 10000, maxAttempts: 1 },
          determinism: { pureFunction: true }
        },
        {
          id: 'load',
          name: 'Post Report',
          type: 'http.request',
          dependsOn: ['reduce'],
          inputs: { url: 'https://api.example.com/reports', method: 'POST', headers: { 'Content-Type': 'application/json' } },
          policy: { timeoutMs: 15000, maxAttempts: 3, backoffStrategy: 'exponential', backoffBaseMs: 1000 },
          determinism: {
            usesExternalApis: true,
            pureFunction: false,
            externalDependencies: [
              { name: 'reports-api', kind: 'http-api', deterministic: true, evidenceCapture: 'response-hash' }
            ]
          }
        }
      ]
    }
  }
];

// ---- Rendering ------------------------------------------------------------
function render() {
  const app = document.getElementById('app');
  if (!state.account) {
    app.innerHTML = renderSetup();
    bindSetup();
  } else {
    app.innerHTML = renderApp();
    bindApp();
  }
}

// ---- Setup screen ---------------------------------------------------------
function renderSetup() {
  return `
    <div class="setup-screen">
      <div class="setup-card">
        <h2>Bilko Flow</h2>
        <p>Deterministic workflow orchestration. Create an account to get started with building and running flows.</p>
        <div class="form-group">
          <label>Account Name</label>
          <input type="text" id="setup-name" placeholder="My Organization" />
        </div>
        <div class="form-group">
          <label>Admin Identity ID</label>
          <input type="text" id="setup-identity" placeholder="user-1" />
          <div class="form-hint">An identity ID for auth headers. Any string works for this reference implementation.</div>
        </div>
        <button class="btn btn-primary" id="setup-btn" style="width:100%;justify-content:center;margin-top:8px;">Create Account</button>
      </div>
    </div>`;
}

function bindSetup() {
  const btn = document.getElementById('setup-btn');
  if (!btn) return;
  btn.addEventListener('click', async () => {
    const name = document.getElementById('setup-name').value.trim();
    const identity = document.getElementById('setup-identity').value.trim();
    if (!name || !identity) { toast('Fill in both fields', 'error'); return; }

    btn.innerHTML = '<span class="spinner"></span> Creating...';
    btn.disabled = true;
    try {
      // Set identity before making the call
      state.identity = identity;
      const data = await apiCall('POST', '/api/accounts', { name, adminIdentityId: identity });
      state.account = data.account;
      state.project = data.project;
      state.environments = data.environments;
      saveSession();
      toast('Account created');
      render();
    } catch (err) {
      toast(err.message, 'error');
      btn.innerHTML = 'Create Account';
      btn.disabled = false;
    }
  });
}

// ---- Main app shell -------------------------------------------------------
function renderApp() {
  return `
    <div class="app">
      ${renderSidebar()}
      <div class="main">
        ${renderTopbar()}
        <div class="content" id="view-content">
          ${renderView()}
        </div>
      </div>
    </div>`;
}

function renderSidebar() {
  const envName = state.environments[0]?.name || 'N/A';
  return `
    <div class="sidebar">
      <div class="sidebar-header">
        <h1>Bilko Flow</h1>
        <span>v0.1.0 / DSL 1.0.0</span>
      </div>
      <div class="sidebar-nav">
        <button class="nav-item ${state.view === 'dashboard' ? 'active' : ''}" data-view="dashboard">
          ${icons.dashboard} Dashboard
        </button>
        <button class="nav-item ${state.view === 'workflows' ? 'active' : ''}" data-view="workflows">
          ${icons.workflow} Workflows
        </button>
        <button class="nav-item ${state.view === 'runs' ? 'active' : ''}" data-view="runs">
          ${icons.runs} Runs
        </button>
      </div>
      <div class="sidebar-footer">
        <div class="tenant-info">
          <div><span class="label">Account</span><span class="value" title="${state.account?.id}">${state.account?.name}</span></div>
          <div><span class="label">Project</span><span class="value" title="${state.project?.id}">${state.project?.name}</span></div>
          <div><span class="label">Environment</span><span class="value">${envName}</span></div>
        </div>
        <button class="btn btn-sm" id="logout-btn" style="width:100%;justify-content:center;margin-top:12px;">
          ${icons.logout} Sign Out
        </button>
      </div>
    </div>`;
}

function renderTopbar() {
  const titles = {
    dashboard: 'Dashboard',
    workflows: state.selectedWorkflow ? 'Workflow Detail' : 'Workflows',
    runs: state.selectedRun ? 'Run Detail' : 'Runs',
  };
  let actions = '';
  if (state.view === 'workflows' && !state.selectedWorkflow) {
    actions = `<button class="btn btn-primary" id="create-workflow-btn">${icons.plus} New Workflow</button>`;
  }
  if (state.view === 'workflows' && state.selectedWorkflow) {
    actions = `<button class="btn" id="back-btn">&larr; Back</button>
               <button class="btn btn-primary" id="run-workflow-btn">${icons.runs} Start Run</button>`;
  }
  if (state.view === 'runs' && state.selectedRun) {
    actions = `<button class="btn" id="back-btn">&larr; Back</button>
               <button class="btn" id="refresh-run-btn">${icons.refresh} Refresh</button>`;
  }
  if (state.view === 'runs' && !state.selectedRun) {
    actions = `<button class="btn" id="refresh-runs-btn">${icons.refresh} Refresh</button>`;
  }
  if (state.view === 'dashboard') {
    actions = `<button class="btn" id="refresh-dash-btn">${icons.refresh} Refresh</button>`;
  }
  return `
    <div class="topbar">
      <h2>${titles[state.view]}</h2>
      <div class="topbar-actions">${actions}</div>
    </div>`;
}

function renderView() {
  switch (state.view) {
    case 'dashboard': return renderDashboard();
    case 'workflows': return state.selectedWorkflow ? renderWorkflowDetail() : renderWorkflowList();
    case 'runs': return state.selectedRun ? renderRunDetail() : renderRunList();
    default: return '';
  }
}

// ---- Dashboard view -------------------------------------------------------
function renderDashboard() {
  const totalWf = state.workflows.length;
  const activeWf = state.workflows.filter(w => w.status === 'active').length;
  const totalRuns = state.runs.length;
  const succeeded = state.runs.filter(r => r.status === 'succeeded').length;
  const failed = state.runs.filter(r => r.status === 'failed').length;
  const running = state.runs.filter(r => r.status === 'running' || r.status === 'queued').length;

  const recentRuns = [...state.runs].sort((a, b) => b.createdAt.localeCompare(a.createdAt)).slice(0, 5);

  return `
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Workflows</div>
        <div class="stat-value">${totalWf}</div>
        <div class="stat-sub">${activeWf} active</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Runs</div>
        <div class="stat-value">${totalRuns}</div>
        <div class="stat-sub">${running} in progress</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Succeeded</div>
        <div class="stat-value" style="color:var(--green)">${succeeded}</div>
        <div class="stat-sub">${totalRuns ? Math.round(succeeded / totalRuns * 100) : 0}% success rate</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Failed</div>
        <div class="stat-value" style="color:var(--red)">${failed}</div>
        <div class="stat-sub">${totalRuns ? Math.round(failed / totalRuns * 100) : 0}% failure rate</div>
      </div>
    </div>
    <div class="table-wrap">
      <div class="table-header">
        <h3>Recent Runs</h3>
      </div>
      ${recentRuns.length ? `
        <table>
          <thead><tr>
            <th>Run ID</th><th>Workflow</th><th>Status</th><th>Created</th>
          </tr></thead>
          <tbody>
            ${recentRuns.map(r => {
              const wf = state.workflows.find(w => w.id === r.workflowId);
              return `<tr>
                <td class="id-cell" data-run-id="${r.id}">${r.id.slice(0, 16)}...</td>
                <td>${wf ? wf.name : r.workflowId.slice(0, 16)}</td>
                <td>${statusBadge(r.status)}</td>
                <td style="color:var(--text-secondary)">${timeAgo(r.createdAt)}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      ` : `
        <div class="empty-state">
          ${icons.empty}
          <h3>No runs yet</h3>
          <p>Create a workflow and start a run to see activity here.</p>
        </div>
      `}
    </div>
    ${!state.workflows.length ? renderSampleTemplates() : ''}`;
}

// ---- Sample template rendering --------------------------------------------
function renderSampleTemplates() {
  return `
    <div style="margin-top:24px">
      <div class="section-heading">Sample Flows</div>
      <div class="section-subheading">Get started quickly with a pre-built workflow template. Click to create.</div>
      <div class="templates-grid">
        ${SAMPLE_FLOWS.map(t => `
          <div class="template-card" data-template-id="${t.id}">
            <div class="template-icon" style="background:${t.iconBg}">${t.icon}</div>
            <h4>${t.title}</h4>
            <p>${t.description}</p>
            <div class="template-meta">
              ${gradeBadge(t.grade)}
              <span class="badge badge-draft"><span class="badge-dot"></span>${t.payload.steps.length} steps</span>
            </div>
            <div class="template-steps-preview">
              ${t.payload.steps.map((s, i) => `${i > 0 ? '<span class="step-arrow">&rarr;</span>' : ''}<span class="step-chip">${s.type}</span>`).join('')}
            </div>
          </div>
        `).join('')}
      </div>
    </div>`;
}

// ---- Workflow list --------------------------------------------------------
function renderWorkflowList() {
  if (!state.workflows.length) {
    return `
      <div class="empty-state">
        ${icons.empty}
        <h3>No workflows</h3>
        <p>Create your first workflow from scratch or pick a sample template below.</p>
        <button class="btn btn-primary" id="create-workflow-btn-empty">${icons.plus} New Workflow</button>
      </div>
      ${renderSampleTemplates()}`;
  }
  return `
    <div class="table-wrap">
      <table>
        <thead><tr>
          <th>Name</th><th>ID</th><th>Status</th><th>Version</th><th>Steps</th><th>Determinism</th><th>Updated</th>
        </tr></thead>
        <tbody>
          ${state.workflows.map(w => `
            <tr>
              <td><strong style="cursor:pointer" class="wf-link" data-wf-id="${w.id}">${w.name}</strong></td>
              <td class="id-cell wf-link" data-wf-id="${w.id}">${w.id.slice(0, 20)}...</td>
              <td>${statusBadge(w.status)}</td>
              <td style="font-family:var(--mono)">v${w.version}</td>
              <td>${w.steps.length}</td>
              <td>${gradeBadge(w.determinism.targetGrade)}</td>
              <td style="color:var(--text-secondary)">${timeAgo(w.updatedAt)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>`;
}

// ---- Workflow detail -------------------------------------------------------
function renderWorkflowDetail() {
  const w = state.selectedWorkflow;
  if (!w) return '';

  // Build step dependency graph
  const stepMap = {};
  w.steps.forEach(s => stepMap[s.id] = s);

  return `
    <div class="detail-panel">
      <div class="detail-header">
        <h3>${w.name}</h3>
        <div style="display:flex;gap:8px">
          ${statusBadge(w.status)}
          ${gradeBadge(w.determinism.targetGrade)}
        </div>
      </div>
      <div class="detail-body">
        <div class="detail-grid">
          <div class="detail-field">
            <div class="field-label">Workflow ID</div>
            <div class="field-value mono">${w.id}</div>
          </div>
          <div class="detail-field">
            <div class="field-label">Version</div>
            <div class="field-value mono">v${w.version}</div>
          </div>
          <div class="detail-field">
            <div class="field-label">Spec Version</div>
            <div class="field-value mono">${w.specVersion}</div>
          </div>
          <div class="detail-field">
            <div class="field-label">Entry Step</div>
            <div class="field-value mono">${w.entryStepId}</div>
          </div>
          <div class="detail-field">
            <div class="field-label">Created</div>
            <div class="field-value">${new Date(w.createdAt).toLocaleString()}</div>
          </div>
          <div class="detail-field">
            <div class="field-label">Updated</div>
            <div class="field-value">${new Date(w.updatedAt).toLocaleString()}</div>
          </div>
        </div>
        ${w.description ? `<p style="margin-top:16px;color:var(--text-secondary);font-size:13px">${w.description}</p>` : ''}
      </div>
    </div>

    <div class="detail-panel">
      <div class="detail-header"><h3>Flow Graph</h3></div>
      <div class="detail-body" style="padding:0">
        <div class="flow-canvas">
          ${renderFlowGraph(w)}
        </div>
      </div>
    </div>

    <div class="detail-panel">
      <div class="detail-header"><h3>Steps (${w.steps.length})</h3></div>
      <div class="detail-body" style="padding:0">
        <table>
          <thead><tr><th>Name</th><th>Type</th><th>ID</th><th>Depends On</th><th>Timeout</th><th>Retries</th></tr></thead>
          <tbody>
            ${w.steps.map(s => `
              <tr>
                <td><strong>${s.name}</strong></td>
                <td><code style="background:var(--bg);padding:2px 6px;border-radius:4px;font-size:11px">${s.type}</code></td>
                <td style="font-family:var(--mono);font-size:12px;color:var(--text-secondary)">${s.id}</td>
                <td style="font-family:var(--mono);font-size:12px;color:var(--text-secondary)">${s.dependsOn.length ? s.dependsOn.join(', ') : '&mdash;'}</td>
                <td style="font-family:var(--mono);font-size:12px">${s.policy.timeoutMs}ms</td>
                <td style="font-family:var(--mono);font-size:12px">${s.policy.maxAttempts}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>

    <div class="detail-panel">
      <div class="detail-header"><h3>DSL Definition</h3></div>
      <div class="detail-body">
        <div class="json-view">${syntaxHighlight(JSON.stringify(w, null, 2))}</div>
      </div>
    </div>`;
}

// ---- Flow graph rendering -------------------------------------------------
function renderFlowGraph(workflow, stepResults) {
  const steps = workflow.steps;
  const stepMap = {};
  steps.forEach(s => stepMap[s.id] = s);

  // Topological sort into layers
  const layers = [];
  const placed = new Set();
  const remaining = [...steps];

  while (remaining.length) {
    const layer = remaining.filter(s =>
      s.dependsOn.every(d => placed.has(d))
    );
    if (!layer.length) break; // circular or broken
    layers.push(layer);
    layer.forEach(s => placed.add(s.id));
    remaining.splice(0, remaining.length, ...remaining.filter(s => !placed.has(s.id)));
  }

  let html = '<div class="flow-graph">';
  layers.forEach((layer, li) => {
    if (li > 0) {
      html += '<div class="flow-connector"></div><div class="flow-connector-arrow"></div>';
    }
    if (layer.length === 1) {
      html += renderFlowNode(layer[0], workflow.entryStepId, stepResults);
    } else {
      html += '<div class="flow-parallel">';
      layer.forEach(s => {
        html += `<div class="flow-parallel-branch">${renderFlowNode(s, workflow.entryStepId, stepResults)}</div>`;
      });
      html += '</div>';
    }
  });
  html += '</div>';
  return html;
}

function renderFlowNode(step, entryId, stepResults) {
  let cls = '';
  if (step.id === entryId) cls += ' entry';
  if (stepResults && stepResults[step.id]) {
    cls += ` step-${stepResults[step.id].status}`;
  }
  return `
    <div class="flow-node${cls}">
      <div class="node-type">${step.type}</div>
      <div class="node-name">${step.name}</div>
      <div class="node-id">${step.id}</div>
    </div>`;
}

// ---- Run list -------------------------------------------------------------
function renderRunList() {
  if (!state.runs.length) {
    return `
      <div class="empty-state">
        ${icons.empty}
        <h3>No runs</h3>
        <p>Start a run from a workflow to see execution results here.</p>
      </div>`;
  }

  const sorted = [...state.runs].sort((a, b) => b.createdAt.localeCompare(a.createdAt));
  return `
    <div class="table-wrap">
      <table>
        <thead><tr>
          <th>Run ID</th><th>Workflow</th><th>Version</th><th>Status</th><th>Determinism</th><th>Created</th><th>Duration</th>
        </tr></thead>
        <tbody>
          ${sorted.map(r => {
            const wf = state.workflows.find(w => w.id === r.workflowId);
            const duration = r.completedAt && r.startedAt
              ? `${((new Date(r.completedAt) - new Date(r.startedAt))).toFixed(0)}ms`
              : (r.startedAt ? 'Running...' : '&mdash;');
            return `<tr>
              <td class="id-cell run-link" data-run-id="${r.id}">${r.id.slice(0, 20)}...</td>
              <td>${wf ? wf.name : r.workflowId.slice(0, 16)}</td>
              <td style="font-family:var(--mono)">v${r.workflowVersion}</td>
              <td>${statusBadge(r.status)}</td>
              <td>${r.determinismGrade ? gradeBadge(r.determinismGrade) : '<span style="color:var(--text-secondary)">&mdash;</span>'}</td>
              <td style="color:var(--text-secondary)">${timeAgo(r.createdAt)}</td>
              <td style="font-family:var(--mono);font-size:12px">${duration}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>`;
}

// ---- Run detail -----------------------------------------------------------
function renderRunDetail() {
  const r = state.selectedRun;
  if (!r) return '';

  const wf = state.workflows.find(w => w.id === r.workflowId);
  const stepEntries = Object.entries(r.stepResults || {});

  return `
    <div class="detail-panel">
      <div class="detail-header">
        <h3>Run ${r.id.slice(0, 20)}...</h3>
        <div style="display:flex;gap:8px;align-items:center">
          ${statusBadge(r.status)}
          ${r.status === 'running' || r.status === 'queued' ? `<button class="btn btn-sm btn-danger" id="cancel-run-btn">Cancel</button>` : ''}
        </div>
      </div>
      <div class="detail-body">
        <div class="detail-grid">
          <div class="detail-field">
            <div class="field-label">Run ID</div>
            <div class="field-value mono">${r.id}</div>
          </div>
          <div class="detail-field">
            <div class="field-label">Workflow</div>
            <div class="field-value">${wf ? wf.name : r.workflowId}</div>
          </div>
          <div class="detail-field">
            <div class="field-label">Workflow Version</div>
            <div class="field-value mono">v${r.workflowVersion}</div>
          </div>
          <div class="detail-field">
            <div class="field-label">Determinism Grade</div>
            <div class="field-value">${r.determinismGrade ? gradeBadge(r.determinismGrade) : 'N/A'}</div>
          </div>
          <div class="detail-field">
            <div class="field-label">Created</div>
            <div class="field-value">${new Date(r.createdAt).toLocaleString()}</div>
          </div>
          <div class="detail-field">
            <div class="field-label">Started</div>
            <div class="field-value">${r.startedAt ? new Date(r.startedAt).toLocaleString() : 'N/A'}</div>
          </div>
          <div class="detail-field">
            <div class="field-label">Completed</div>
            <div class="field-value">${r.completedAt ? new Date(r.completedAt).toLocaleString() : 'N/A'}</div>
          </div>
          <div class="detail-field">
            <div class="field-label">Duration</div>
            <div class="field-value mono">${r.completedAt && r.startedAt ? `${(new Date(r.completedAt) - new Date(r.startedAt))}ms` : 'N/A'}</div>
          </div>
        </div>
        ${r.error ? `<div style="margin-top:16px;padding:12px;background:rgba(225,112,85,0.1);border:1px solid var(--red);border-radius:var(--radius);font-size:13px"><strong>Error:</strong> ${r.error.message} <code style="font-size:11px">(${r.error.code})</code></div>` : ''}
      </div>
    </div>

    ${wf ? `
    <div class="detail-panel">
      <div class="detail-header"><h3>Flow Graph</h3></div>
      <div class="detail-body" style="padding:0">
        <div class="flow-canvas">
          ${renderFlowGraph(wf, r.stepResults)}
        </div>
      </div>
    </div>
    ` : ''}

    <div class="detail-panel">
      <div class="detail-header"><h3>Step Results (${stepEntries.length})</h3></div>
      <div class="detail-body" style="padding:12px">
        ${stepEntries.length ? stepEntries.map(([sid, sr]) => {
          const step = wf?.steps.find(s => s.id === sid);
          return `
            <div class="step-result-item">
              <div class="step-result-header" data-toggle="${sid}">
                <div style="display:flex;align-items:center;gap:10px">
                  <span>${statusBadge(sr.status)}</span>
                  <strong style="font-size:13px">${step ? step.name : sid}</strong>
                  <code style="font-size:11px;color:var(--text-secondary)">${step ? step.type : ''}</code>
                </div>
                <div style="font-family:var(--mono);font-size:12px;color:var(--text-secondary)">
                  ${sr.durationMs ? `${sr.durationMs}ms` : ''} ${sr.attempts > 1 ? `(${sr.attempts} attempts)` : ''}
                </div>
              </div>
              <div class="step-result-body" id="step-body-${sid}">
                ${sr.outputs ? `<div style="margin-bottom:8px"><strong style="font-size:12px">Outputs:</strong><div class="json-view" style="margin-top:4px">${syntaxHighlight(JSON.stringify(sr.outputs, null, 2))}</div></div>` : ''}
                ${sr.error ? `<div><strong style="font-size:12px;color:var(--red)">Error:</strong><div class="json-view" style="margin-top:4px;border-color:var(--red)">${syntaxHighlight(JSON.stringify(sr.error, null, 2))}</div></div>` : ''}
              </div>
            </div>`;
        }).join('') : '<div style="text-align:center;color:var(--text-secondary);padding:20px">No step results yet</div>'}
      </div>
    </div>

    <div class="detail-panel">
      <div class="detail-header"><h3>Raw Run Data</h3></div>
      <div class="detail-body">
        <div class="json-view">${syntaxHighlight(JSON.stringify(r, null, 2))}</div>
      </div>
    </div>`;
}

// ---- Helpers --------------------------------------------------------------
function statusBadge(status) {
  return `<span class="badge badge-${status}"><span class="badge-dot"></span>${status}</span>`;
}

function gradeBadge(grade) {
  return `<span class="badge badge-${grade}">${grade}</span>`;
}

function timeAgo(iso) {
  const diff = Date.now() - new Date(iso).getTime();
  const s = Math.floor(diff / 1000);
  if (s < 60) return `${s}s ago`;
  const m = Math.floor(s / 60);
  if (m < 60) return `${m}m ago`;
  const h = Math.floor(m / 60);
  if (h < 24) return `${h}h ago`;
  const d = Math.floor(h / 24);
  return `${d}d ago`;
}

function syntaxHighlight(json) {
  return json
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/"([^"]+)":/g, '<span style="color:#74b9ff">"$1"</span>:')
    .replace(/: "([^"]*)"/g, ': <span style="color:#00b894">"$1"</span>')
    .replace(/: (\d+)/g, ': <span style="color:#fdcb6e">$1</span>')
    .replace(/: (true|false)/g, ': <span style="color:#e17055">$1</span>')
    .replace(/: null/g, ': <span style="color:#636e72">null</span>');
}

// ---- Event binding --------------------------------------------------------
function bindApp() {
  // Nav
  document.querySelectorAll('.nav-item').forEach(el => {
    el.addEventListener('click', () => {
      state.view = el.dataset.view;
      state.selectedWorkflow = null;
      state.selectedRun = null;
      render();
    });
  });

  // Logout
  document.getElementById('logout-btn')?.addEventListener('click', () => {
    localStorage.removeItem('bilko_session');
    localStorage.removeItem('bilko_workflows');
    localStorage.removeItem('bilko_runs');
    state.account = null;
    state.project = null;
    state.environments = [];
    state.identity = null;
    state.workflows = [];
    state.runs = [];
    render();
  });

  // Create workflow buttons
  document.getElementById('create-workflow-btn')?.addEventListener('click', showCreateWorkflowModal);
  document.getElementById('create-workflow-btn-empty')?.addEventListener('click', showCreateWorkflowModal);

  // Sample template cards
  document.querySelectorAll('.template-card').forEach(el => {
    el.addEventListener('click', () => createFromTemplate(el.dataset.templateId));
  });

  // Workflow links
  document.querySelectorAll('.wf-link').forEach(el => {
    el.addEventListener('click', () => {
      const wf = state.workflows.find(w => w.id === el.dataset.wfId);
      if (wf) { state.selectedWorkflow = wf; state.view = 'workflows'; render(); }
    });
  });

  // Run links
  document.querySelectorAll('.run-link, [data-run-id]').forEach(el => {
    el.addEventListener('click', async () => {
      try {
        const data = await apiCall('GET', `/api/runs/${el.dataset.runId}`);
        if (data.run) { state.selectedRun = data.run; state.view = 'runs'; render(); }
      } catch (err) { toast(err.message, 'error'); }
    });
  });

  // Back button
  document.getElementById('back-btn')?.addEventListener('click', () => {
    state.selectedWorkflow = null;
    state.selectedRun = null;
    render();
  });

  // Run workflow button
  document.getElementById('run-workflow-btn')?.addEventListener('click', async () => {
    if (!state.selectedWorkflow) return;
    try {
      const data = await apiCall('POST', `/api/workflows/${state.selectedWorkflow.id}/runs`, {});
      trackRun(data.run.id);
      state.runs.push(data.run);
      toast(`Run started: ${data.run.id.slice(0, 16)}`);
      state.selectedRun = data.run;
      state.view = 'runs';
      render();
    } catch (err) { toast(err.message, 'error'); }
  });

  // Cancel run
  document.getElementById('cancel-run-btn')?.addEventListener('click', async () => {
    if (!state.selectedRun) return;
    try {
      const data = await apiCall('POST', `/api/runs/${state.selectedRun.id}/cancel`, { reason: 'Canceled from UI' });
      state.selectedRun = data.run;
      toast('Run canceled');
      render();
    } catch (err) { toast(err.message, 'error'); }
  });

  // Refresh
  document.getElementById('refresh-run-btn')?.addEventListener('click', async () => {
    if (!state.selectedRun) return;
    try {
      const data = await apiCall('GET', `/api/runs/${state.selectedRun.id}`);
      state.selectedRun = data.run;
      // Update in runs array too
      const idx = state.runs.findIndex(r => r.id === data.run.id);
      if (idx >= 0) state.runs[idx] = data.run;
      render();
    } catch (err) { toast(err.message, 'error'); }
  });

  document.getElementById('refresh-runs-btn')?.addEventListener('click', async () => {
    await loadRuns();
    render();
  });

  document.getElementById('refresh-dash-btn')?.addEventListener('click', async () => {
    await Promise.all([loadWorkflows(), loadRuns()]);
    render();
  });

  // Step result toggles
  document.querySelectorAll('.step-result-header').forEach(el => {
    el.addEventListener('click', () => {
      const body = document.getElementById(`step-body-${el.dataset.toggle}`);
      if (body) body.classList.toggle('open');
    });
  });
}

// ---- Create from sample template ------------------------------------------
async function createFromTemplate(templateId) {
  const template = SAMPLE_FLOWS.find(t => t.id === templateId);
  if (!template) return;

  const card = document.querySelector(`[data-template-id="${templateId}"]`);
  if (card) {
    card.style.opacity = '0.6';
    card.style.pointerEvents = 'none';
  }

  try {
    const payload = JSON.parse(JSON.stringify(template.payload));
    payload.accountId = state.account.id;
    payload.projectId = state.project.id;
    payload.environmentId = state.environments[0].id;

    const data = await apiCall('POST', '/api/workflows', payload);
    trackWorkflow(data.workflow.id);
    state.workflows.push(data.workflow);
    toast(`Created: ${data.workflow.name}`);
    state.selectedWorkflow = data.workflow;
    state.view = 'workflows';
    render();
  } catch (err) {
    toast(err.message, 'error');
    if (card) {
      card.style.opacity = '1';
      card.style.pointerEvents = 'auto';
    }
  }
}

// ---- Create workflow modal ------------------------------------------------
function showCreateWorkflowModal() {
  const root = document.getElementById('modal-root');

  const sampleDsl = JSON.stringify({
    name: "My Flow",
    description: "A sample workflow",
    determinism: {
      targetGrade: "best-effort"
    },
    entryStepId: "step-1",
    steps: [
      {
        id: "step-1",
        name: "Fetch Data",
        type: "http.request",
        dependsOn: [],
        inputs: { url: "https://api.example.com/data", method: "GET" },
        policy: { timeoutMs: 30000, maxAttempts: 3, backoffStrategy: "exponential", backoffBaseMs: 1000 },
        determinism: { usesExternalApis: true, pureFunction: false }
      },
      {
        id: "step-2",
        name: "Transform Results",
        type: "transform.map",
        dependsOn: ["step-1"],
        inputs: { expression: "item.title" },
        policy: { timeoutMs: 5000, maxAttempts: 1 },
        determinism: { pureFunction: true }
      }
    ]
  }, null, 2);

  root.innerHTML = `
    <div class="modal-overlay" id="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h3>Create Workflow</h3>
          <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="tabs">
            <button class="tab active" data-tab="form">Form</button>
            <button class="tab" data-tab="json">JSON DSL</button>
          </div>
          <div id="tab-form">
            <div class="form-group">
              <label>Workflow Name</label>
              <input type="text" id="wf-name" placeholder="My Workflow" />
            </div>
            <div class="form-group">
              <label>Description (optional)</label>
              <input type="text" id="wf-description" placeholder="What does this workflow do?" />
            </div>
            <div class="form-group">
              <label>Determinism Target</label>
              <select id="wf-determinism">
                <option value="best-effort">Best Effort</option>
                <option value="replayable">Replayable</option>
                <option value="pure">Pure</option>
              </select>
            </div>
            <div class="form-group">
              <label>Steps JSON</label>
              <textarea id="wf-steps" rows="10" placeholder='[{"id":"step-1","name":"Fetch","type":"http.request",...}]'>${JSON.stringify([
                {
                  id: "step-1", name: "Fetch Data", type: "http.request", dependsOn: [],
                  inputs: { url: "https://api.example.com/data", method: "GET" },
                  policy: { timeoutMs: 30000, maxAttempts: 3, backoffStrategy: "exponential", backoffBaseMs: 1000 },
                  determinism: { usesExternalApis: true, pureFunction: false }
                },
                {
                  id: "step-2", name: "Transform", type: "transform.map", dependsOn: ["step-1"],
                  inputs: { expression: "item.title" },
                  policy: { timeoutMs: 5000, maxAttempts: 1 },
                  determinism: { pureFunction: true }
                }
              ], null, 2)}</textarea>
              <div class="form-hint">JSON array of step definitions. Each step needs: id, name, type, dependsOn, inputs, policy.</div>
            </div>
            <div class="form-group">
              <label>Entry Step ID</label>
              <input type="text" id="wf-entry" value="step-1" />
            </div>
          </div>
          <div id="tab-json" style="display:none">
            <div class="form-group">
              <label>Full Workflow DSL (JSON)</label>
              <textarea id="wf-json" rows="16">${sampleDsl.replace(/</g,'&lt;')}</textarea>
              <div class="form-hint">Paste or write a complete workflow DSL document. Must include name, determinism, entryStepId, and steps.</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" id="modal-cancel">Cancel</button>
          <button class="btn btn-primary" id="modal-create">Create Workflow</button>
        </div>
      </div>
    </div>`;

  let activeTab = 'form';

  // Tab switching
  root.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      activeTab = tab.dataset.tab;
      root.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('tab-form').style.display = activeTab === 'form' ? 'block' : 'none';
      document.getElementById('tab-json').style.display = activeTab === 'json' ? 'block' : 'none';
    });
  });

  // Close
  const close = () => { root.innerHTML = ''; };
  document.getElementById('modal-close').addEventListener('click', close);
  document.getElementById('modal-cancel').addEventListener('click', close);
  document.getElementById('modal-overlay').addEventListener('click', (e) => {
    if (e.target.id === 'modal-overlay') close();
  });

  // Create
  document.getElementById('modal-create').addEventListener('click', async () => {
    const btn = document.getElementById('modal-create');
    btn.innerHTML = '<span class="spinner"></span> Creating...';
    btn.disabled = true;

    try {
      let payload;
      if (activeTab === 'json') {
        payload = JSON.parse(document.getElementById('wf-json').value);
      } else {
        const name = document.getElementById('wf-name').value.trim();
        const description = document.getElementById('wf-description').value.trim();
        const determinism = document.getElementById('wf-determinism').value;
        const steps = JSON.parse(document.getElementById('wf-steps').value);
        const entryStepId = document.getElementById('wf-entry').value.trim();
        if (!name) throw new Error('Name is required');
        if (!steps.length) throw new Error('At least one step is required');

        payload = {
          name,
          description: description || undefined,
          determinism: { targetGrade: determinism },
          entryStepId,
          steps,
        };
      }

      // Add tenant context
      payload.accountId = state.account.id;
      payload.projectId = state.project.id;
      payload.environmentId = state.environments[0].id;

      const data = await apiCall('POST', '/api/workflows', payload);
      trackWorkflow(data.workflow.id);
      state.workflows.push(data.workflow);
      toast(`Workflow created: ${data.workflow.name}`);
      close();
      state.selectedWorkflow = data.workflow;
      state.view = 'workflows';
      render();
    } catch (err) {
      toast(err.message, 'error');
      btn.innerHTML = 'Create Workflow';
      btn.disabled = false;
    }
  });
}

// ---- Init -----------------------------------------------------------------
async function init() {
  if (loadSession()) {
    await Promise.all([loadWorkflows(), loadRuns()]);
  }
  render();
}

init();
</script>
</body>
</html>
